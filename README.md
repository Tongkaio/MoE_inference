# requirements
CUDA >= 11.0
CMake >= 3.18

```shell
# 编译
mkdir build && cd build
cmake .. -DCMAKE_PREFIX_PATH=$CONDA_PREFIX/lib/python3.10/site-packages/torch/share/cmake/Torch
make

# 运行
cd ..
python bench.py
```

输出结果：
```
=== profiling qwen moe block ===
------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg    # of Calls  
------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                    aten::index_add_         0.03%       1.074ms        65.01%        2.748s      42.941ms     355.000us         0.01%        2.753s      43.013ms            64  
                  aten::scatter_add_        64.98%        2.747s        64.98%        2.747s      42.923ms        2.752s        65.01%        2.752s      43.007ms            64  
                        aten::linear         0.04%       1.707ms        26.30%        1.112s       5.760ms       1.375ms         0.03%        1.119s       5.798ms           193  
                        aten::matmul         0.02%     999.000us        26.20%        1.107s       5.738ms     624.000us         0.01%        1.114s       5.773ms           193  
                            aten::mm        26.17%        1.106s        26.17%        1.106s       5.732ms        1.113s        26.28%        1.114s       5.770ms           193  
                         aten::index         8.26%     349.261ms         8.28%     350.005ms       2.734ms     342.394ms         8.09%     343.193ms       2.681ms           128  
                         aten::zeros         0.00%      20.000us         0.19%       7.909ms       3.954ms       7.000us         0.00%       9.794ms       4.897ms             2  
                         aten::zero_         0.00%      16.000us         0.19%       7.886ms       3.943ms       4.000us         0.00%       9.785ms       4.893ms             2  
                         aten::fill_         0.19%       7.870ms         0.19%       7.870ms       1.968ms       9.783ms         0.23%       9.783ms       2.446ms             4  
                         aten::where         0.01%     271.000us         0.07%       3.143ms      49.109us     162.000us         0.00%       4.490ms      70.156us            64  
------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 4.227s
Self CUDA time total: 4.234s

=== profiling manual qwen moe block ===
-----------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                         Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg    # of Calls  
-----------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                 aten::matmul         0.09%     777.000us        85.08%     705.593ms       5.386ms     537.000us         0.06%     704.727ms       5.380ms           131  
                     aten::mm        84.97%     704.651ms        84.97%     704.672ms       5.379ms     703.192ms        82.76%     704.190ms       5.375ms           131  
                  aten::copy_         3.18%      26.335ms         3.18%      26.335ms      15.779us      37.504ms         4.41%      37.504ms      22.471us          1669  
                 aten::select         2.32%      19.222ms         2.70%      22.377ms       3.885us      29.920ms         3.52%      36.841ms       6.396us          5760  
                    aten::mul         2.17%      17.986ms         2.17%      17.986ms      34.722us      18.774ms         2.21%      18.774ms      36.243us           518  
                  aten::zeros         0.01%      61.000us         1.95%      16.169ms       3.234ms      17.000us         0.00%      15.287ms       3.057ms             5  
                  aten::zero_         0.00%      27.000us         1.94%      16.084ms       3.217ms      10.000us         0.00%      15.265ms       3.053ms             5  
                  aten::fill_         1.94%      16.053ms         1.94%      16.053ms       4.013ms      15.255ms         1.80%      15.255ms       3.814ms             4  
                    aten::add         1.07%       8.874ms         1.08%       8.925ms       2.975ms       9.562ms         1.13%       9.570ms       3.190ms             3  
                   aten::item         0.59%       4.853ms         0.72%       5.969ms       3.886us       5.867ms         0.69%       7.731ms       5.033us          1536  
-----------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 829.292ms
Self CUDA time total: 849.695ms

tensor(1.7695e-08, grad_fn=<MaxBackward1>)
=== profiling cuda qwen moe block ===
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                                   Name    Self CPU %      Self CPU   CPU total %     CPU total  CPU time avg     Self CUDA   Self CUDA %    CUDA total  CUDA time avg    # of Calls  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
                                               aten::to         0.05%      74.000us        85.94%     137.604ms       8.600ms      48.000us         0.03%     133.805ms       8.363ms            16  
                                         aten::_to_copy        -1.30%   -2074.000us        85.89%     137.529ms       8.596ms      87.000us         0.06%     133.757ms       8.360ms            16  
                                            aten::copy_         1.45%       2.314ms        85.42%     136.780ms       8.549ms     133.351ms        90.72%     133.351ms       8.334ms            16  
                                            aten::zeros         0.06%     102.000us        11.27%      18.048ms       1.504ms      50.000us         0.03%      13.188ms       1.099ms            12  
                                            aten::zero_         0.01%      22.000us        11.20%      17.928ms       1.494ms      21.000us         0.01%      13.117ms       1.093ms            12  
                                            aten::fill_        11.18%      17.906ms        11.18%      17.906ms       3.581ms      13.096ms         8.91%      13.096ms       2.619ms             5  
                                    aten::empty_strided         0.06%     104.000us         0.36%     574.000us      35.875us     319.000us         0.22%     319.000us      19.938us            16  
                                            aten::empty         0.01%      18.000us         0.01%      18.000us       1.500us      21.000us         0.01%      21.000us       1.750us            12  
                                        cudaEventRecord         0.01%      11.000us         0.01%      11.000us       0.052us       0.000us         0.00%       0.000us       0.000us           210  
                                  cudaStreamIsCapturing         0.00%       0.000us         0.00%       0.000us       0.000us       0.000us         0.00%       0.000us       0.000us             5  
-------------------------------------------------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  ------------  
Self CPU time total: 160.122ms
Self CUDA time total: 146.993ms

max_diff = 7.636845111846924e-08
python output:
size(torch.Size([128, 2048]))
tensor([[-0.0030,  0.0013,  0.0059,  ..., -0.0081, -0.0178,  0.0036],
        [ 0.0002,  0.0057, -0.0034,  ..., -0.0059, -0.0025,  0.0034],
        [ 0.0081, -0.0054,  0.0090,  ...,  0.0034, -0.0032,  0.0165],
        ...,
        [-0.0002, -0.0139, -0.0023,  ..., -0.0036,  0.0087,  0.0041],
        [-0.0096,  0.0013, -0.0102,  ...,  0.0015,  0.0367, -0.0135],
        [ 0.0061,  0.0124,  0.0078,  ..., -0.0023, -0.0076, -0.0083]])

cuda output:
size(torch.Size([128, 2048]))
tensor([[-0.0030,  0.0013,  0.0059,  ..., -0.0081, -0.0178,  0.0036],
        [ 0.0002,  0.0057, -0.0034,  ..., -0.0059, -0.0025,  0.0034],
        [ 0.0081, -0.0054,  0.0090,  ...,  0.0034, -0.0032,  0.0165],
        ...,
        [-0.0002, -0.0139, -0.0023,  ..., -0.0036,  0.0087,  0.0041],
        [-0.0096,  0.0013, -0.0102,  ...,  0.0015,  0.0367, -0.0135],
        [ 0.0061,  0.0124,  0.0078,  ..., -0.0023, -0.0076, -0.0083]])
```